# Интеграция открытой линии Битрикс24 с Telegram ботом

Решение для передачи сообщений между открытой линией Битрикс24 и Telegram ботом **без использования вебхуков Битрикс24** (работает в бесплатной версии).

## Возможности

- ✅ Получение сообщений из открытой линии через JavaScript виджет
- ✅ Пересылка сообщений в Telegram бот
- ✅ Отправка ответов из Telegram обратно в открытую линию
- ✅ Работает без доступа к REST API Битрикс24
- ✅ Не требует настройки вебхуков в Битрикс24

## Требования

- Node.js версии 14 или выше
- Telegram бот (создать через @BotFather)
- Доступ к редактированию HTML страницы с виджетом открытой линии
- Публичный URL для сервера (можно использовать ngrok для тестирования)

## Установка

1. Установите зависимости:
```bash
npm install
```

2. Скопируйте файл `.env.example` в `.env`:
```bash
copy .env.example .env
```

3. Заполните настройки в файле `.env`

## Настройка

### 1. Создание Telegram бота

1. Откройте Telegram и найдите @BotFather
2. Отправьте команду `/newbot`
3. Следуйте инструкциям для создания бота
4. Скопируйте полученный токен в `TELEGRAM_BOT_TOKEN`

### 2. Получение ID чата в Telegram

1. Откройте бота в Telegram
2. Отправьте команду `/start` боту
3. Откройте в браузере: `https://api.telegram.org/bot<YOUR_BOT_TOKEN>/getUpdates`
4. Найдите `"chat":{"id":` в ответе (будет показан в сообщении бота)
5. Скопируйте ID в `TELEGRAM_ADMIN_CHAT_ID`

### 3. Настройка сервера

1. Запустите сервер: `npm start`
2. Для тестирования используйте ngrok:
```bash
ngrok http 3000
```
3. Скопируйте полученный URL (например: `https://abc123.ngrok.io`)

### 4. Установка виджета на сайт

Добавьте следующий код на страницу с виджетом открытой линии Битрикс24 (перед закрывающим тегом `</body>`):

```html
<script>
	// Настройки виджета
	window.BITRIX_TG_BRIDGE_URL = 'https://your-server-url.com'; // URL вашего сервера
	window.BITRIX_OPENLINE_CODE = 'your_openline_code'; // Опционально: код открытой линии
</script>
<script src="https://your-server-url.com/widget.js"></script>
```

**Где взять код открытой линии:**
- В настройках открытой линии в Битрикс24
- Или оставьте пустым, виджет будет работать и без него

### 5. Размещение на хостинге

**Бесплатные платформы для Node.js:**

1. **Render** (рекомендуется)
   - Бесплатный тариф с ограничениями
   - Автоматическое развертывание из GitHub
   - HTTPS по умолчанию
   - Сайт: https://render.com

2. **Railway**
   - Бесплатный тариф с $5 кредитами в месяц
   - Простое развертывание
   - Сайт: https://railway.app

3. **Amvera Cloud** (российский)
   - Стартовый баланс для тестирования
   - Сайт: https://amvera.ru

4. **Google Cloud Run**
   - Бесплатный тариф с ограничениями
   - Сайт: https://cloud.google.com/run

5. **Vercel** (для статики + API)
   - Бесплатный тариф
   - Сайт: https://vercel.com

**Для тестирования:**
- **ngrok** - создает публичный URL для локального сервера
  - Скачать: https://ngrok.com
  - Запуск: `ngrok http 3000`

## Запуск

```bash
npm start
```

Для разработки с автоматической перезагрузкой:
```bash
npm run dev
```

## Как это работает

1. Клиент отправляет сообщение в открытую линию на сайте
2. JavaScript виджет перехватывает сообщение
3. Виджет отправляет сообщение на ваш сервер
4. Сервер пересылает сообщение в Telegram бот
5. Вы отвечаете на сообщение в Telegram (Reply)
6. Виджет периодически проверяет сервер на наличие ответов
7. Ответ автоматически вставляется в чат открытой линии
8. Клиент видит ответ в открытой линии

## Структура проекта

- `server.js` - основной сервер и логика интеграции
- `public/widget.js` - JavaScript виджет для перехвата сообщений на сайте
- `env.example` - пример файла с настройками
- `.env` - настройки (не коммитится в git)
- `package.json` - зависимости проекта

## Устранение неполадок

**Сообщения не приходят в Telegram:**
- Проверьте, что виджет установлен на странице с открытой линией
- Откройте консоль браузера (F12) и проверьте наличие ошибок
- Убедитесь, что URL сервера в настройках виджета правильный
- Проверьте, что сервер запущен и доступен

**Ответы не приходят в открытую линию:**
- Убедитесь, что вы отвечаете на сообщение (Reply), а не отправляете новое
- Проверьте логи сервера на наличие ошибок
- Убедитесь, что виджет загружен на странице (проверьте консоль браузера)

**Виджет не работает:**
- Проверьте, что скрипт виджета загружается (вкладка Network в консоли браузера)
- Убедитесь, что виджет открытой линии Битрикс24 загружен на странице
- Проверьте правильность URL сервера в настройках

**Бот не отвечает:**
- Проверьте токен бота в `.env`
- Убедитесь, что бот запущен и получает обновления
- Проверьте логи сервера

## Безопасность

- Не публикуйте файл `.env` в открытом доступе
- Используйте HTTPS для продакшена
- Ограничьте доступ к вебхукам по IP (если возможно)

